<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Chatbot</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Include marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
body{
  margin:0;
  font-family:system-ui,Arial;
  background:#0f172a;
  color:#fff;
  display:flex;
  flex-direction:column;
  height:100vh;
}
header{
  padding:12px;
  background:#020617;
  text-align:center;
  font-weight:700;
  font-size:18px;
}
#chat{
  flex:1;
  padding:15px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}
.msg{
  margin-bottom:14px;
  line-height:1.5;
  max-width:85%;
  padding:10px 15px;
  border-radius:12px;
}
.user{ 
  color:#38bdf8; 
  background:#1e293b;
  align-self:flex-end;
}
.ai{ 
  color:#a3e635; 
  background:#1e293b;
  align-self:flex-start;
}
footer{
  display:flex;
  gap:8px;
  padding:12px;
  background:#020617;
  border-top:1px solid #1e293b;
}
textarea{
  flex:1;
  resize:none;
  border-radius:8px;
  border:1px solid #1e293b;
  padding:12px;
  font-size:15px;
  background:#0f172a;
  color:#fff;
  font-family:inherit;
}
button{
  padding:10px 20px;
  border:none;
  border-radius:8px;
  background:#22c55e;
  color:#000;
  font-weight:700;
  cursor:pointer;
  min-width:80px;
}
button:disabled{
  background:#4ade80;
  cursor:not-allowed;
  opacity:0.7;
}
.typing{
  font-style:italic;
  opacity:0.7;
}
</style>
</head>

<body>

<header>ðŸ¤– AI Chatbot</header>

<div id="chat">
  <div class="msg ai">Hello! I'm your AI assistant. How can I help you today?</div>
</div>

<footer>
  <textarea id="input" placeholder="Type your messageâ€¦" rows="1"></textarea>
  <button id="sendBtn" onclick="sendMessage()">Send</button>
</footer>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");

function addMessage(text, className, isHTML = false) {
  const div = document.createElement("div");
  div.className = `msg ${className}`;
  
  if (isHTML) {
    div.innerHTML = text;
  } else {
    div.textContent = text;
  }
  
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function simulateTyping(element, text, callback) {
  let i = 0;
  element.innerHTML = "";
  
  function typeChar() {
    if (i < text.length) {
      element.innerHTML += text.charAt(i);
      chat.scrollTop = chat.scrollHeight;
      i++;
      setTimeout(typeChar, 20); // Adjust typing speed
    } else if (callback) {
      callback();
    }
  }
  
  typeChar();
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  
  // Add user message
  addMessage(`You: ${text}`, "user");
  input.value = "";
  
  // Disable button and input during request
  sendBtn.disabled = true;
  input.disabled = true;
  sendBtn.textContent = "Sending...";
  
  // Add typing indicator
  const typingElement = addMessage("AI is thinking...", "ai typing");
  
  try {
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json" 
      },
      body: JSON.stringify({ 
        message: text,
        timestamp: new Date().toISOString()
      })
    });
    
    if (!response.ok) {
      throw new Error(`Server responded with ${response.status}`);
    }
    
    const data = await response.json();
    
    // Remove typing indicator
    chat.removeChild(typingElement);
    
    // Add AI response with typing effect
    const aiElement = addMessage("", "ai");
    simulateTyping(aiElement, `AI: ${data.reply || "No response received."}`);
    
  } catch (error) {
    console.error("Error:", error);
    
    // Remove typing indicator
    if (typingElement.parentNode === chat) {
      chat.removeChild(typingElement);
    }
    
    // Show error message
    addMessage(`AI: Error - ${error.message}`, "ai");
    
  } finally {
    // Re-enable button and input
    sendBtn.disabled = false;
    input.disabled = false;
    sendBtn.textContent = "Send";
    input.focus();
  }
}

// Auto-resize textarea
input.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});

// Enter key to send (without Shift)
input.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Focus input on load
input.focus();
</script>

</body>
</html>
